{% extends 'base.html' %}
{% block title %}Let's Quiz | {{ quiz.title }} eredm√©nyeid{% endblock title %}

{% block content %}
<div class="container py-5">
  <div class="row justify-content-center">
    <div class="col-lg-10">

      <!-- √ñsszes√≠tett pontsz√°m k√°rtya -->
      <div class="card shadow-lg border-0 rounded-3 mb-4 quiz-card">
        <div class="card-body text-center">
          <h2 class="h4 mb-2">{{ quiz.title }} ‚Äì √∂sszes√≠tett eredm√©nyed</h2>
          <p class="text-muted mb-1">√ñsszpontsz√°m:</p>
          <div class="display-4 font-weight-bold text-success">
            {{ total_score }}
          </div>

          <div class="mt-4">
            <a href="{% url 'quiz:quiz_end' quiz.id %}" class="btn btn-info btn-continue mt-2 ml-2">
              Vissza a kv√≠z v√©g√©hez
            </a>
          </div>
        </div>
      </div>

      <!-- K√©rd√©senk√©nti eredm√©nyek -->
      {% for a in attempts %}
        <div class="card shadow-sm border-0 rounded-3 mb-4 quiz-card">
          <div class="card-body">

            <!-- Fejl√©c: k√©rd√©s sorsz√°ma + helyes / helytelen badge -->
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h3 class="h5 mb-0">K√©rd√©s {{ forloop.counter }}.</h3>
              {% if a.is_correct %}
                <span class="badge badge-success px-3 py-2">‚úÖ Helyes</span>
              {% else %}
                <span class="badge badge-danger px-3 py-2">‚ùå Helytelen</span>
              {% endif %}
            </div>

            <!-- K√©rd√©s sz√∂veg dobozban -->
            <div class="question-text mb-4">
              {{ a.question.html|safe }}
            </div>

            <!-- A te v√°laszod -->
            <div class="mb-3">
              <h5 class="text-muted mb-2">A te v√°laszod:</h5>

              {# P√ÅROS√çT√ì K√âRD√âS #}
              {% if a.question.matching_pairs.all %}
                <ul class="list-unstyled mb-0">
                  {% for p in a.question.matching_pairs.all %}
                    {% for m in a.attempted_matches.all %}
                      {% if m.left_pair.id == p.id %}
                        {% if m.chosen_right_pair and m.chosen_right_pair.id == p.id %}
                          <li class="alert alert-success py-2 mb-2">
                            ‚úÖ {{ p.left_text }} ‚áî {{ p.right_text }}
                          </li>
                        {% elif m.chosen_right_pair %}
                          <li class="alert alert-danger py-2 mb-2">
                            ‚ùå {{ p.left_text }} ‚áî {{ m.chosen_right_pair.right_text }}
                            <small class="d-block text-muted">
                              (helyes: {{ p.right_text }})
                            </small>
                          </li>
                        {% else %}
                          <li class="alert alert-warning py-2 mb-2">
                            ‚ö†Ô∏è {{ p.left_text }} ‚áî <em>nincs p√°ros√≠t√°s</em>
                            <small class="d-block text-muted">
                              (helyes: {{ p.right_text }})
                            </small>
                          </li>
                        {% endif %}
                      {% endif %}
                    {% endfor %}
                  {% endfor %}
                </ul>

              {# SZ√ñVEGES K√âRD√âS #}
              {% elif a.question.correct_text_answer %}
                {% if a.text_answer %}
                  <div class="alert alert-secondary py-2 mb-2">
                    {{ a.text_answer }}
                  </div>
                {% else %}
                  <p class="text-warning mb-0">Nem adt√°l meg v√°laszt.</p>
                {% endif %}

              {# V√ÅLASZT√ìS (single / multiple) ‚Äì kijel√∂lt v√°laszok #}
              {% elif a.selected_choices.all %}
                {% for choice in a.selected_choices.all %}
                  <div class="alert alert-secondary py-2 mb-2">
                    {{ choice.html|safe }}
                  </div>
                {% endfor %}

              {% else %}
                <p class="text-warning mb-0">Nem v√°lasztott√°l semmit.</p>
              {% endif %}
            </div>

            <!-- Helyes v√°laszok -->
            <div class="mb-3">
              <h5 class="text-muted mb-2">Helyes v√°lasz(ok):</h5>

              {# Matching helyes p√°rok #}
              {% if a.question.matching_pairs.all %}
                <ul class="list-unstyled mb-0">
                  {% for p in a.question.matching_pairs.all %}
                    <li class="alert alert-info py-2 mb-2">
                      {{ p.left_text }} ‚áî {{ p.right_text }}
                    </li>
                  {% endfor %}
                </ul>

              {# Sz√∂veges helyes v√°lasz #}
              {% elif a.question.correct_text_answer %}
                <div class="alert alert-info py-2 mb-2">
                  üí° {{ a.question.correct_text_answer }}
                </div>

              {# V√°laszt√≥s ‚Äì jel√∂lj√ºk, melyik helyes / hib√°s / kihagyott #}
              {% else %}
                {% for choice in a.question.choices.all %}
                  {% if choice in a.selected_choices.all %}
                    {% if choice.is_correct %}
                      <div class="alert alert-success py-2 mb-2">
                        ‚úÖ {{ choice.html|safe }} (helyes v√°laszt√°s)
                      </div>
                    {% else %}
                      <div class="alert alert-danger py-2 mb-2">
                        ‚ùå {{ choice.html|safe }} (hib√°s v√°laszt√°s)
                      </div>
                    {% endif %}
                  {% elif choice.is_correct %}
                    <div class="alert alert-info py-2 mb-2">
                      üí° {{ choice.html|safe }} (helyes v√°lasz, amit nem jel√∂lt√©l)
                    </div>
                  {% endif %}
                {% endfor %}
              {% endif %}
            </div>

            <!-- Pontsz√°m -->
            <div class="d-flex justify-content-between align-items-center mt-3">
              <span class="text-muted">
                Pont: <strong>{{ a.marks_obtained }}</strong>
              </span>
              {% if a.is_correct %}
                <span class="badge badge-success px-3 py-2">
                  ‚úÖ Teljes pont
                </span>
              {% else %}
                <span class="badge badge-light px-3 py-2">
                  R√©szpont / 0 pont
                </span>
              {% endif %}
            </div>

          </div>
        </div>
      {% empty %}
        <p>Nincs egyetlen attempt sem ehhez a kv√≠zhez.</p>
      {% endfor %}

    </div>
  </div>
</div>
{% endblock %}
